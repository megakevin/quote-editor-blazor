@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore

@inject QuoteEditorBlazor.Data.QuoteEditorContext context

<header class="navbar">
  <AuthorizeView>
    <Authorized>
      <div class="navbar__brand">
        @currentCompanyName
      </div>
      <div class="navbar__name">
        @context.User.Identity.Name
      </div>

      <a class="btn btn--dark" href="/logout">Sign out</a>
    </Authorized>
    <NotAuthorized>
      <a class="btn btn--dark navbar__right" href="/login">Sign in</a>
    </NotAuthorized>
  </AuthorizeView>
</header>

@code {
    [CascadingParameter]
    Task<AuthenticationState> authenticationStateTask { get; set; }

    string currentCompanyName;

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateTask;

        if (authState.User.Identity.IsAuthenticated)
        {
            var currentUserId = authState.User.Claims.First(c => c.Type == ClaimTypes.NameIdentifier).Value;
            var user = await context.Users.Include(u => u.Company).FirstAsync(u => u.Id == currentUserId);

            currentCompanyName = user.Company.Name;
        }
    }
}

